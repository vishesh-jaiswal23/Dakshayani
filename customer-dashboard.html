<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Dashboard | Dakshayani Enterprises</title>
    <meta name="description" content="Customer dashboard for viewing project status, documents, and support at Dakshayani Enterprises.">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons (Social Media, etc.) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .solar-gold { color: #FBBF24; }
        .bg-solar-gold { background-color: #FBBF24; }
        .border-solar-gold { border-color: #FBBF24; }
        .hover\:bg-solar-gold-dark:hover { background-color: #F59E0B; }
        .transition-all-smooth { transition: all 0.3s ease-in-out; }
        .dashboard-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Stepper styles */
        .stepper-item {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .stepper-item.completed .stepper-circle {
            background-color: #16a34a;
            border-color: #16a34a;
            color: white;
        }
        .stepper-item.active .stepper-circle {
            background-color: #FBBF24;
            border-color: #FBBF24;
            color: #1f2937;
        }
        .stepper-item .stepper-line {
            height: 2px;
            flex: 1;
            background-color: #e5e7eb;
        }
        .stepper-item.completed .stepper-line {
            background-color: #16a34a;
        }
        .stepper-circle {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid #e5e7eb;
            background-color: white;
            color: #9ca3af;
        }
        /* Message box styles (copied from admin-dashboard for consistency) */
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .message-box.success {
            background-color: #d1fae5; /* green-100 */
            color: #065f46; /* green-800 */
        }
        .message-box.error {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
        }
        .message-box.info {
            background-color: #dbeafe; /* blue-100 */
            color: #1e40af; /* blue-800 */
        }
        /* Modal styles (copied from admin-dashboard for consistency) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        /* Logo container styles for header */
        .logo-container {
            background-color: #FBBF24; /* Solar Gold background */
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-lg */
            transition: all 0.3s ease-in-out; /* Smooth transition for hover effects */
        }
        .logo-container:hover {
            transform: translateY(-2px) scale(1.02); /* Slight lift and scale */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgb(0 0 0 / 0.1); /* Subtle dark shadow on hover */
        }
        /* Fixed Contact Buttons Container */
        .fixed-contact-buttons {
            position: fixed;
            bottom: 1.5rem; /* Adjust as needed */
            right: 1.5rem; /* Adjust as needed */
            z-index: 100; /* Ensure it's above other content */
            display: flex;
            flex-direction: column; /* Stack buttons vertically */
            gap: 0.75rem; /* Space between buttons */
        }
        .fixed-contact-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 3.5rem; /* Fixed width for circular button */
            height: 3.5rem; /* Fixed height for circular button */
            border-radius: 9999px; /* Make it circular */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            transition: all 0.2s ease-in-out;
            color: white; /* Default icon color */
            font-size: 0.75rem; /* Smaller text for icon labels */
            text-align: center;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .fixed-contact-button:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2), 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        /* Specific button colors */
        .fixed-contact-button.call { background-color: #34D399; /* green-400 */ }
        .fixed-contact-button.whatsapp { background-color: #25D366; /* WhatsApp green */ }
        .fixed-contact-button.email { background-color: #EF4444; /* red-500 */ }
        .fixed-contact-button.pmsgy { background-color: #6366F1; /* indigo-500 */ }

        .fixed-contact-button i { /* Targeting Font Awesome icons */
            font-size: 1.5rem; /* Icon size */
        }

        /* Responsive adjustments for fixed contact buttons */
        @media (max-width: 768px) {
            .fixed-contact-buttons {
                bottom: 1rem;
                right: 1rem;
                flex-direction: row; /* Arrange horizontally on small screens */
                flex-wrap: wrap; /* Allow wrapping if too many buttons */
                justify-content: flex-end; /* Align to the right */
                gap: 0.5rem;
            }
            .fixed-contact-button {
                width: 3rem;
                height: 3rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-gray-900 text-white shadow-md sticky top-0 z-50" id="main-header">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <!-- Logo and company name wrapped in a gold pill background -->
                <div class="flex items-center space-x-2 bg-solar-gold px-4 py-2 rounded-lg shadow-md logo-container">
                    <img src="images/New dakshayani logo centered small.png" alt="Dakshayani Enterprises Logo" class="h-8 w-auto">
                    <span class="text-xl font-extrabold tracking-tight text-gray-900">Dakshayani Enterprises</span>
                </div>
            </a>
            <nav class="hidden md:flex items-center space-x-6">
                <span class="font-semibold">Customer Portal</span>
                <a href="customer-dashboard.html" class="text-solar-gold font-bold">My Project</a>
                <button id="logout-button" class="bg-red-500 text-white px-4 py-2 rounded-md font-bold hover:bg-red-600 transition-all-smooth">Logout</button>
            </nav>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="text-white focus:outline-none">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                </button>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-gray-900">
            <a href="customer-dashboard.html" class="block py-2 px-6 text-solar-gold font-bold">My Project</a>
            <a href="#" class="block py-2 px-6 hover:bg-gray-800 rounded">Referrals</a>
            <button id="mobile-logout-button" class="block mt-2 mx-4 mb-4 text-center bg-red-500 text-white px-4 py-2 rounded-md font-bold hover:bg-red-600 transition-all-smooth w-auto">Logout</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome, <span id="customer-name">Customer!</span></h1>
        <p class="text-gray-600 mb-6">Your User ID: <span id="customer-uid" class="font-mono text-sm text-gray-500">Loading...</span></p>

        <!-- Quick Project Summary -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="dashboard-card p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Current Project Status</p>
                    <p class="text-2xl font-bold text-gray-900" id="current-project-status">Loading...</p>
                </div>
                <div class="bg-blue-100 text-blue-600 p-3 rounded-full">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.125 1.125 0 011.591 0L21.75 12M2.25 12a8.96 8.96 0 01-1.591-5.036L21.75 12m0 0a8.96 8.96 0 01-5.036 1.591L2.25 12m11.25-8.864a8.963 8.963 0 015.036-1.591l-1.591 1.591M13.5 3.364a8.963 8.963 0 00-5.036 1.591l1.591-1.591" /></svg>
                </div>
            </div>
            <div class="dashboard-card p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">System Size</p>
                    <p class="text-2xl font-bold text-gray-900" id="system-size">Loading...</p>
                </div>
                <div class="bg-green-100 text-green-600 p-3 rounded-full">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                </div>
            </div>
            <div class="dashboard-card p-6 flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-500">Estimated Annual Savings</p>
                    <p class="text-2xl font-bold text-gray-900" id="annual-savings">Loading...</p>
                </div>
                <div class="bg-yellow-100 text-yellow-600 p-3 rounded-full">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                </div>
            </div>
        </div>

        <!-- Support & Complaint Management -->
        <div class="dashboard-card p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Support & Complaints</h2>
            
            <!-- Submit New Complaint Form -->
            <div class="mb-6 border-b pb-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-3">Submit a New Complaint</h3>
                <form id="submit-complaint-form" class="space-y-4">
                    <div>
                        <label for="complaint-type" class="block text-sm font-medium text-gray-700">Issue Type</label>
                        <select id="complaint-type" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-solar-gold focus:border-solar-gold" required>
                            <option value="">Select an issue type</option>
                            <option value="System Performance Issue">System Performance Issue</option>
                            <option value="Equipment Malfunction">Equipment Malfunction (Panel/Inverter)</option>
                            <option value="Billing/Payment Query">Billing/Payment Query</option>
                            <option value="Maintenance Request">Maintenance Request</option>
                            <option value="General Inquiry">General Inquiry</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label for="complaint-project" class="block text-sm font-medium text-gray-700">Related Project (Optional)</label>
                        <select id="complaint-project" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-solar-gold focus:border-solar-gold">
                            <option value="">Select a project</option>
                            <!-- Projects will be dynamically loaded here -->
                        </select>
                    </div>
                    <div>
                        <label for="complaint-description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="complaint-description" rows="4" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:ring-solar-gold focus:border-solar-gold" placeholder="Describe your issue in detail..." required></textarea>
                    </div>
                    <button type="submit" class="w-full bg-solar-gold text-gray-900 px-4 py-2 rounded-lg font-bold hover:bg-solar-gold-dark transition-all-smooth">Submit Complaint</button>
                </form>
            </div>

            <!-- My Support Tickets History -->
            <div>
                <h3 class="text-lg font-semibold text-gray-800 mb-3">My Support Tickets</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ticket ID</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue Type</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="complaints-table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-3 py-2 text-center text-gray-500">Loading complaints...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Referral Program Section (Placeholder) -->
        <div class="dashboard-card p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Referral Program</h2>
            <p class="text-gray-600">Love your solar experience? Refer friends and family to Dakshayani Enterprises and earn exciting rewards!</p>
            <div class="mt-4">
                <a href="rewards.html" class="inline-block bg-solar-gold text-gray-900 px-6 py-2 rounded-md font-bold hover:bg-solar-gold-dark transition-all-smooth">Learn About Rewards</a>
            </div>
            <p class="text-sm text-gray-500 mt-3">Your successful referrals: <span id="successful-referrals">0</span> | Total Earnings: <span id="total-referral-earnings">₹0</span></p>
        </div>

    </main>
    
    <!-- Complaint Details Modal -->
    <div id="complaint-details-modal" class="modal-overlay">
        <div class="modal-content w-full md:w-3/4 lg:w-1/2">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 class="text-2xl font-bold text-gray-900">Complaint Details - <span id="modal-complaint-id"></span></h3>
                <button class="text-gray-500 hover:text-gray-800 text-2xl" onclick="closeComplaintDetailsModal()">&times;</button>
            </div>
            <div id="modal-complaint-body" class="space-y-4 text-gray-700">
                <p><strong>Issue Type:</strong> <span id="modal-complaint-type"></span></p>
                <p><strong>Related Project:</strong> <span id="modal-complaint-project"></span></p>
                <p><strong>Date Submitted:</strong> <span id="modal-complaint-date"></span></p>
                <p><strong>Status:</strong> <span id="modal-complaint-status"></span></p>
                <p><strong>Description:</strong> <br><span id="modal-complaint-description" class="block p-3 bg-gray-50 rounded-md"></span></p>
                <p><strong>Resolution Notes:</strong> <br><span id="modal-complaint-resolution" class="block p-3 bg-gray-50 rounded-md italic">No resolution notes yet.</span></p>
            </div>
            <div class="mt-6 text-right">
                <button class="bg-gray-300 text-gray-800 px-5 py-2 rounded-md hover:bg-gray-400" onclick="closeComplaintDetailsModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Fixed Contact Buttons -->
    <div class="fixed-contact-buttons">
        <a href="tel:+917070278178" class="fixed-contact-button call" title="Call Us">
            <i class="fas fa-phone"></i>
        </a>
        <a href="https://wa.me/917070278178" target="_blank" rel="noopener noreferrer" class="fixed-contact-button whatsapp" title="WhatsApp Us">
            <i class="fab fa-whatsapp"></i>
        </a>
        <a href="mailto:d.entranchi@gmail.com" class="fixed-contact-button email" title="Email Us">
            <i class="fas fa-envelope"></i>
        </a>
        <a href="https://pmsuryaghar.gov.in" target="_blank" rel="noopener noreferrer" class="fixed-contact-button pmsgy" title="Visit PM Surya Ghar Website">
            <i class="fas fa-solar-panel"></i>
        </a>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            addDoc, // For adding new complaints
            collection, 
            query, 
            where, 
            getDocs,
            orderBy // For ordering projects/complaints
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAgYPNJNCte7vEjqlFdcoa62arKhEuCwXI",
            authDomain: "dakshayani-enterprises.firebaseapp.com",
            projectId: "dakshayani-enterprises",
            storageBucket: "dakshayani-enterprises.firebasestorage.app",
            messagingSenderId: "129241224273",
            appId: "1:129241224273:web:23b484f6645f4e27afd470",
            measurementId: "G-VFEY23QHE8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Define appId for Firestore paths
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global variable to store the current user's UID
        let currentCustomerUid = null;

        // --- Helper Functions ---
        const getUserProfileDocRef = (uid) => doc(db, `artifacts/${appId}/users/${uid}/user_data`, 'profile');
        const getProjectsCollectionRef = () => collection(db, 'projects'); // Top-level projects collection
        const getComplaintsCollectionRef = () => collection(db, 'complaints'); // Top-level complaints collection

        function showMessage(type, message) {
            const existingMessage = document.querySelector('.message-box');
            if (existingMessage) existingMessage.remove();

            const messageBox = document.createElement('div');
            messageBox.className = `message-box ${type}`;
            messageBox.innerHTML = `
                <p>${message}</p>
                <button class="ml-auto text-current opacity-75 hover:opacity-100" onclick="this.parentElement.remove()">&times;</button>
            `;
            document.body.appendChild(messageBox);

            setTimeout(() => messageBox.remove(), 5000);
        }

        // --- Core Authentication and Page Load Logic ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDocRef = getUserProfileDocRef(user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    // Check if the user is a customer AND is approved (customers are auto-approved)
                    if (userData.role === 'customer' && userData.isApproved) {
                        currentCustomerUid = user.uid; // Set the global UID
                        document.getElementById('customer-name').textContent = userData.name || userData.email;
                        document.getElementById('customer-uid').textContent = user.uid;
                        loadCustomerDashboardData();
                    } else {
                        // Not an approved customer, redirect to login
                        showMessage('error', 'Access Denied. You must be an approved customer to view this page.');
                        setTimeout(async () => { 
                            await signOut(auth); 
                            window.location.href = 'login.html?loggedOut=true'; 
                        }, 2000);
                    }
                } else {
                    showMessage('error', 'User profile not found. Please log in again.');
                    setTimeout(async () => { 
                        await signOut(auth); 
                        window.location.href = 'login.html?loggedOut=true'; 
                    }, 2000);
                }
            } else {
                showMessage('info', 'Please log in to access your Customer Dashboard.');
                setTimeout(() => { 
                    window.location.href = 'login.html?loggedOut=true'; 
                }, 1000);
            }
        });

        // --- Logout Functionality ---
        const setupLogout = (buttonId) => {
            document.getElementById(buttonId).addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage('success', 'Logged out successfully!');
                    setTimeout(() => { 
                        window.location.href = 'index.html?loggedOut=true'; 
                    }, 1000);
                } catch (error) {
                    console.error("Logout Error:", error);
                    showMessage('error', 'Failed to log out. Please try again.');
                }
            });
        };
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('logout-button')) {
                setupLogout('logout-button');
            }
            if (document.getElementById('mobile-menu')) { // Check if mobile menu exists before trying to find its logout button
                const mobileLogoutButton = document.getElementById('mobile-logout-button');
                if (mobileLogoutButton) {
                    setupLogout('mobile-logout-button');
                }
            }
        });

        // --- Main Data Loading Function ---
        async function loadCustomerDashboardData() {
            if (!currentCustomerUid) {
                console.error("Customer UID not available for loading dashboard data.");
                return;
            }
            // Load all relevant data concurrently
            await Promise.all([
                loadCustomerProjects(),
                loadCustomerComplaints(),
                populateComplaintProjectDropdown()
            ]);
        }

        // --- Load Customer's Projects and Update Stepper/Summary ---
        async function loadCustomerProjects() {
            const currentProjectStatusEl = document.getElementById('current-project-status');
            const systemSizeEl = document.getElementById('system-size');
            const annualSavingsEl = document.getElementById('annual-savings');
            // Removed projectStepper related elements as the section is removed from HTML
            // const projectStepper = document.getElementById('project-stepper');
            // const stepperLabels = [ ... ];
            // const stepperItems = projectStepper.querySelectorAll('.stepper-item');
            // const stepperCircles = projectStepper.querySelectorAll('.stepper-circle');
            // const stepperLines = projectStepper.querySelectorAll('.stepper-line');


            currentProjectStatusEl.textContent = 'Loading...';
            systemSizeEl.textContent = 'Loading...';
            annualSavingsEl.textContent = 'Loading...';
            // Removed stepper related UI updates
            // stepperItems.forEach(item => item.classList.remove('active', 'completed'));
            // stepperCircles.forEach(circle => circle.innerHTML = ''); // Clear checkmarks

            try {
                const q = query(getProjectsCollectionRef(), 
                                where('customerUid', '==', currentCustomerUid),
                                orderBy('createdAt', 'desc') // Get the most recent project if multiple
                                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    currentProjectStatusEl.textContent = 'No active project found.';
                    systemSizeEl.textContent = 'N/A';
                    annualSavingsEl.textContent = 'N/A';
                    // Removed stepper related UI updates
                    // projectStepper.innerHTML = '<p class="text-center text-gray-500 w-full">No active project to display progress.</p>';
                    return;
                }

                // Assuming the first document is the primary/most recent project
                const project = querySnapshot.docs[0].data();

                currentProjectStatusEl.textContent = project.status || 'N/A';
                systemSizeEl.textContent = project.systemSize || 'N/A';
                annualSavingsEl.textContent = `₹${(project.annualSavings || 0).toLocaleString('en-IN')}`; // Assuming 'annualSavings' field

                // Removed stepper update logic
                // const statusMap = { ... };
                // const currentStepIndex = statusMap[project.status] !== undefined ? statusMap[project.status] : -1;
                // stepperItems.forEach((item, index) => { ... });
                // if (currentStepIndex === stepperLabels.length - 1 && stepperLines.length > 0) { ... }

            } catch (error) {
                console.error("Error loading customer projects:", error);
                showMessage('error', 'Error loading project data.');
                currentProjectStatusEl.textContent = 'Error';
                systemSizeEl.textContent = 'Error';
                annualSavingsEl.textContent = 'Error';
                // Removed stepper related UI updates
                // projectStepper.innerHTML = '<p class="text-red-500 text-center w-full">Error loading project progress.</p>';
            }
        }

        // --- Populate Project Dropdown for Complaint Form ---
        async function populateComplaintProjectDropdown() {
            const selectElement = document.getElementById('complaint-project');
            selectElement.innerHTML = '<option value="">Select a project</option>'; // Reset options

            try {
                const q = query(getProjectsCollectionRef(), where('customerUid', '==', currentCustomerUid));
                const querySnapshot = await getDocs(q);

                querySnapshot.forEach(doc => {
                    const project = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id; // Use project document ID as value
                    option.textContent = `${project.customerName || 'Your Project'} - ${project.systemSize || ''} (${project.status || 'N/A'})`;
                    selectElement.appendChild(option);
                });
            } catch (error) {
                console.error("Error populating projects dropdown:", error);
                showMessage('error', 'Could not load projects for complaint form.');
            }
        }

        // --- Submit New Complaint Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const complaintForm = document.getElementById('submit-complaint-form');
            if (complaintForm) {
                complaintForm.addEventListener('submit', async (e) => {
                    e.preventDefault();

                    const issueType = document.getElementById('complaint-type').value;
                    const projectId = document.getElementById('complaint-project').value;
                    const description = document.getElementById('complaint-description').value;

                    if (!issueType || !description) {
                        showMessage('error', 'Please select an issue type and provide a description.');
                        return;
                    }

                    try {
                        const newComplaint = {
                            customerUid: currentCustomerUid,
                            customerName: document.getElementById('customer-name').textContent, // Get current displayed name
                            issueType: issueType,
                            description: description,
                            status: 'Open', // Default status
                            createdAt: new Date(),
                            resolutionNotes: ''
                        };

                        if (projectId) {
                            newComplaint.projectId = projectId;
                        }

                        await addDoc(getComplaintsCollectionRef(), newComplaint);
                        showMessage('success', 'Complaint submitted successfully! Our team will review it shortly.');
                        complaintForm.reset();
                        loadCustomerComplaints(); // Reload complaints list
                    } catch (error) {
                        console.error("Error submitting complaint:", error);
                        showMessage('error', 'Failed to submit complaint. Please try again.');
                    }
                });
            }
        });

        // --- Load Customer's Complaints History ---
        async function loadCustomerComplaints() {
            const complaintsTableBody = document.getElementById('complaints-table-body');
            complaintsTableBody.innerHTML = '<tr><td colspan="5" class="px-3 py-2 text-center text-gray-500">Loading complaints...</td></tr>';

            try {
                const q = query(getComplaintsCollectionRef(), 
                                where('customerUid', '==', currentCustomerUid),
                                orderBy('createdAt', 'desc') // Order by most recent first
                                );
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    complaintsTableBody.innerHTML = '<tr><td colspan="5" class="px-3 py-2 text-center text-gray-500">No complaints found.</td></tr>';
                    return;
                }

                complaintsTableBody.innerHTML = '';
                querySnapshot.forEach(doc => {
                    const complaint = doc.data();
                    const complaintId = doc.id;
                    const complaintDate = complaint.createdAt ? new Date(complaint.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    
                    let statusClass = 'bg-gray-200 text-gray-800';
                    if (complaint.status === 'Open') statusClass = 'bg-red-100 text-red-800';
                    else if (complaint.status === 'In Progress') statusClass = 'bg-yellow-100 text-yellow-800';
                    else if (complaint.status === 'Resolved') statusClass = 'bg-green-100 text-green-800';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap">${complaintId.substring(0, 6)}...</td>
                        <td class="px-3 py-2 whitespace-nowrap">${complaint.issueType || 'N/A'}</td>
                        <td class="px-3 py-2 whitespace-nowrap"><span class="${statusClass} text-xs font-medium px-2.5 py-0.5 rounded-full">${complaint.status || 'N/A'}</span></td>
                        <td class="px-3 py-2 whitespace-nowrap">${complaintDate}</td>
                        <td class="px-3 py-2 whitespace-nowrap">
                            <button class="text-indigo-600 hover:text-indigo-900 text-sm" data-complaint-id="${complaintId}" onclick="showComplaintDetailsModal('${complaintId}')">View Details</button>
                        </td>
                    `;
                    complaintsTableBody.appendChild(row);
                });

            } catch (error) {
                console.error("Error loading customer complaints:", error);
                showMessage('error', 'Error loading your complaints.');
                complaintsTableBody.innerHTML = '<tr><td colspan="5" class="px-3 py-2 text-center text-red-500">Error loading complaints.</td></tr>';
            }
        }

        // --- Complaint Details Modal Functions ---
        const complaintDetailsModal = document.getElementById('complaint-details-modal');
        const modalComplaintId = document.getElementById('modal-complaint-id');
        const modalComplaintType = document.getElementById('modal-complaint-type');
        const modalComplaintProject = document.getElementById('modal-complaint-project');
        const modalComplaintDate = document.getElementById('modal-complaint-date');
        const modalComplaintStatus = document.getElementById('modal-complaint-status');
        const modalComplaintDescription = document.getElementById('modal-complaint-description');
        const modalComplaintResolution = document.getElementById('modal-complaint-resolution');

        async function showComplaintDetailsModal(complaintId) {
            complaintDetailsModal.classList.add('show');
            // Clear previous data
            modalComplaintId.textContent = 'Loading...';
            modalComplaintType.textContent = 'Loading...';
            modalComplaintProject.textContent = 'Loading...';
            modalComplaintDate.textContent = 'Loading...';
            modalComplaintStatus.textContent = 'Loading...';
            modalComplaintDescription.textContent = 'Loading...';
            modalComplaintResolution.textContent = 'Loading...';

            try {
                const complaintDocRef = doc(db, 'complaints', complaintId);
                const complaintDocSnap = await getDoc(complaintDocRef);

                if (complaintDocSnap.exists()) {
                    const complaintData = complaintDocSnap.data();
                    modalComplaintId.textContent = complaintId;
                    modalComplaintType.textContent = complaintData.issueType || 'N/A';
                    modalComplaintDate.textContent = complaintData.createdAt ? new Date(complaintData.createdAt.toDate()).toLocaleDateString() : 'N/A';
                    modalComplaintStatus.textContent = complaintData.status || 'N/A';
                    modalComplaintDescription.textContent = complaintData.description || 'No description provided.';
                    modalComplaintResolution.textContent = complaintData.resolutionNotes || 'No resolution notes yet.';

                    if (complaintData.projectId) {
                        const projectDocRef = doc(db, 'projects', complaintData.projectId);
                        const projectDocSnap = await getDoc(projectDocRef);
                        if (projectDocSnap.exists()) {
                            const projectData = projectDocSnap.data();
                            modalComplaintProject.textContent = `${projectData.customerName || 'Project'} - ${projectData.systemSize || ''}`;
                        } else {
                            modalComplaintProject.textContent = `Project ID: ${complaintData.projectId} (Not Found)`;
                        }
                    } else {
                        modalComplaintProject.textContent = 'N/A';
                    }

                } else {
                    showMessage('error', 'Complaint details not found.');
                    closeComplaintDetailsModal();
                }
            } catch (error) {
                console.error("Error loading complaint details:", error);
                showMessage('error', 'Failed to load complaint details.');
                modalComplaintId.textContent = 'Error';
            }
        }

        function closeComplaintDetailsModal() {
            complaintDetailsModal.classList.remove('show');
        }

        // --- Mobile Menu Toggle (existing) ---
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });

    </script>
</body>
</html>
